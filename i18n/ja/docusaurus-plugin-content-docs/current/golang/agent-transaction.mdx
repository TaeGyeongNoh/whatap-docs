---
id: agent-transaction
title: トランザクション
description: エージェントのトランザクションパフォーマンスを追跡および設定するためのオプションを提供します。
tags:
  - Go
  - トランザクション
---

{@include: ../common-items/_transaction.mdx}

:::note

トランザクションの詳細については、[次の文書](track-transactions-intro)を参照してください。**_ヒートマップ_**を活用したトランザクション分析の案内については、[次の文書](trs-view)を参照してください。

:::

## トランザクショントレーシング

-   **profile_step_normal_count** <span class='type'>Int</span>

    デフォルト値 `1000`

    トランザクショントレースの最大ステップ数を指定します。

-   **profile_step_max_count** <span class='type'>Int</span>

    デフォルト値 `1024`

    収集可能なトレースステップの最大個数を設定します。収集されたトレースステップの数がこの値を超えると、その後収集されるステップはすべて捨てられます。

    :::caution

    設定値を上げすぎると、メモリ使用量が増加します。デフォルト値を変更しないことをお勧めします。 

    :::

-   **profile_step_heavy_count** <span class='type'>Int</span>

    デフォルト値 `1000`

    基本ステップの収集個数を超えると、実行時間が`profile_step_heavy_time`を超えるステップのみを収集します。そのステップの収集可能な数を設定します。Default設定の場合、`profile_step_normal_count`が800であれば、最大200個のステップが収集されます。

-   **profile_step_heavy_time** <span class='type'>Millisecond</span>

    デフォルト値`100`

    Heavyなステップの基準を指定します。指定された値より実行時間が長い場合は、`profile_step_normal_count`を超える場合でも`profile_step_heavy_count`以内で記録されます。

-   **profile_basetime** <span class='type'>Millisecond</span>

    デフォルト値`500`

    トランザクションが設定値以下の時間内に終了した場合、トレース情報を収集しません。ただ、5分単位で最初に呼び出されたURL、エラーが発生したトランザクションに関するトレース情報は収集されます。

-   **query_string_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    トランザクションURLのクエリ ストリングを一緒に収集する機能を活性化します。`whatap.query_string_urls`に登録されたURLのみ適用されます。

-   **query_string_urls** <span class='type'>String</span>

    トランザクションからクエリストリングを収集するURLを登録します。

## HTTPトランザクションの追跡

-   **trace_normalize_enabled** <span class='type'>Boolean</span>

    デフォルト値 `true`

    トランザクションURLを変換して一般化する機能を有効にします。

-   **trace_normalize_urls** <span class='type'>String</span>

    トランザクションURLを変換して一般化する対象URLを指定します。呼び出しURLパターンを変換してパスパラメータを削除します。      

    :::note

    例、**/a/{v}/b**と設定すると、その形式で呼び出されたトランザクションURLは、**/a/{v}/b**形式として変換されます。複数登録するときはコンマ(,)を使います。

    :::

-   **trace_ignore_url_set** <span class='type'>String</span>

    デフォルト値`0`

    特定のURLを設定すると、トランザクション追跡対象から除外されます。設定されたURLはトランザクション情報を収集せず、トランザクション 一覧で確認できません。トランザクション追跡対象から除外するURLを指定します。2つ以上の値を指定する場合は、コンマ(,)を区切り文字として使用します。

-   **trace_ignore_url_prefix** <span class='type'>String</span>

    デフォルト値`0`

    トランザクション追跡対象から除外するURL prefixを指定します。

-   **profile_http_header_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    トレース履歴にHTTPヘッダーの情報を記録する場合に使用します。

-   **profile_http_header_ignore_keys** <span class='type'>String</span>

    デフォルト値`host,accept,user-agent,referer, accept-language, connection`

    HTTP Header名を指定して、収集する情報から除外する機能を追加しました。指定されたHTTP Header名の値は収集から除外され、"#"として表示されます。

-   **profile_http_parameter_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    トレース内訳にhtpパラメータ情報を記録したいときに使用します。パラメータは、別途のセキュリティ キーを入力しないと照会できません。Get、Postパラメータのうち、textタイプの名前と値を収集します。最大40個(Get 20個、Post 20個)を収集し、パラメータ名と値は最大256byteまで収集されます。

    :::note

    セキュリティキーは、_whatap.conf_ファイルがある`WHATAP_HOME`_/paramkey.txt_ファイルに６ケタで設定します。_paramkey.txt_ファイルがない場合は、ランダムに値が自動生成されます。

    :::

-   **profile_http_parameter_url_prefix** <span class='type'>String</span>

    デフォルト値 `/`

    トレース履歴にHTTPパラメータ情報を記録するために、対象URLのprefixを定義する場合に使用します。

-   **profile_http_host_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    トランザクションのHost情報を出力します。値が`false`の場合、トランザクションのURLはURIのみ表示され、`true`の場合は、`/xxx.aaa.com/URL`形式で出力されます。

-   **biz_exceptions** <span class='type'>String</span>

    デフォルト値`Empty`

    特定のErrorまたはExceptionをBusiness Exceptionとして指定します。ヒートマップはエラーと表示せず、統計情報として収集されます。収集されるError Class名と同じように適用します。コンマを区切り文字として複数登録できます。

-   **ignore_exceptions** <span class='type'>String</span>

    無視するExceptionを登録します。ここに登録されると、エラー自体が無視されます。例外にする文字列は、プロファイルのエラーの種類またはエラー統計に関連するクラス項目の文字列です。

    Goでは発生するerrorのTypeを文字列で表記します。

    ```go
    thr.ErrorClassName = fmt.Sprintf("%T", err)
    thr.ErrorMessage = err.Error()

    # error Type 出力

    *errors.errorString
    *echo.HTTPError
    *url.Error
    ```

## トランザクションのトレース

-   **trace_active_transaction_slow_time** <span class='type'>Millisecond</span>

    デフォルト値 `3000`

    収集情報を確認するダッシュボードのアクティブトランザクションアークイコライザーグラフでSlow区間として表記できるトランザクション応答時間の基準を指定します。トランザクションの応答時間が指定時間を超えた場合、Slowアクティブトランザクションの数に含まれます。

-   **trace_active_transaction_very_slow_time** <span class='type'>Millisecond</span>

    デフォルト値 `8000`

-   **trace_active_transaction_lost_time** <span class='type'>Millisecond</span>

    デフォルト値`30000`

    トランザクションの終了を待つ制限時間の5分以内にトランザクションが終了しない場合、トランザクション情報をこの以上収集しません。トランザクションのトレース情報から"Lost Connection"を確認できます。

-   **trace_useragent_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    値が`true`の場合、トランザクションのユーザーエージェント情報を収集します。 

-   **trace_referer_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    値が`true`であれば、トランザクションのRefere情報を収集します。

## マルチトランザクショントレース

-   **mtrace_enabled** <span class='type'>Boolean</span>

    デフォルト値`false`

    マルチトランザクション追跡機能(MTID) を使用可否を設定します。MTIDを追跡すると、登録されたすべてのアプリケーション間の呼び出しを確認できます。

-   **mtrace_rate** <span class='type'>Percentage</span>

    デフォルト値`10`

    最初のトランザクションが発生したときに発行されるMTID(Multi Transaction ID)の発行比率を設定するオプションです。

-   **mtrace_poid_key** <span class='type'>String</span>

    デフォルト値`x-wtap-po`

    MTID追跡に使用するCallerプロジェクトの情報を渡すためのKey Nameを設定します。

-   **mtrace_caller_key** <span class='type'>String</span>

    デフォルト値`x-wtap-mst`

    MTID追跡に使用するCaller Key Nameを設定します。

-   **mtrace_callee_key** <span class='type'>String</span>

    デフォルト値`x-wtap-tx`

    MTID追跡に使用するCallee Key Nameを定義します。

-   **mtrace_send_url_length** <span class='type'>Int</span>

    デフォルト値`80`

    HTTP Callerは、CalleeにURLを渡します。この時、URLの長さを制限しています。この長さを指定します。
